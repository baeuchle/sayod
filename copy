#!/bin/bash

exec_dir=$(dirname $0)
if [ "$(which notify-send)" == "" ]; then
    echo "Kann notify-send nicht finden, bitte installieren";
    exit 127
fi

# make sure notify-send works from cronjob
export XDG_RUNTIME_DIR=/run/user/$(id -u)
if [ -z "$DISPLAY" ]; then
    export DISPLAY=:0.0
fi

function cleanup {
    for part in target source; do
        clean_cmd=$($config --section $part --key release --emptydefault)
        if [ ! -z "$clean_cmd" ]; then
            $clean_cmd
        fi
    done
}
trap cleanup EXIT

function notify {
    msgdate="$(date +%Y-%m-%dT%H:%M:%S)"
    msg=""
    level=$1
    shift
    case "$level" in
        ABORT)
            subject="ABORT"
            urgency="normal"
            head="Backup abgebrochen"
        ;;
        FAIL) # Fehler beim AusfÃ¼hren
            subject="FAIL"
            urgency="critical"
            head="Backup: Fehler $msgdate"
        ;;
        FATAL) # Fehler im Script / Konfiguration
            subject="WTF!"
            urgency="critical"
            head="Backup-Fehler (Fatal)"
        ;;
        START)
            subject="START"
            urgency="low"
            head="Starte Backup"
            msg="$msgdate"
        ;;
        SUCCESS)
            subject="SUCCESS"
            urgency="low"
            head="Backup: Erfolg"
        ;;
        *)
            subject="$1"
            shift
        ;;
    esac
    msg="$* $msg"
    notify-send -u $urgency "$head" "$msg"
    logcmd=$($config --section notify --key log --default cat)
    logpipe=$($config --section notify --key pipe --emptydefault)
    logmsg="$msgdate $subject $msg"
    if [ "$logpipe" == "yes" ]; then
        echo "$logmsg" | $logcmd
    else
        $logcmd "$logmsg"
    fi
}

config_dir="$($exec_dir/config_dir)"
if [ "$?" -ne "0" ] || [ -z "$config_dir" ]; then
    notify FATAL "Kann Konfigurationsverzeichnis nicht bestimmen"
    exit 127;
fi

rc=rc.ini
while [ $# -gt 0 ]; do
    case "$1" in
        --config)
            shift;
            if [[ ! -z "$1" ]]; then
                rc=$1
            fi
            shift;
        ;;
        *)
            shift;
        ;;
    esac
done
config="$exec_dir/config.py --file $config_dir$rc"
if ! $config --doesfileexist --section a --key b; then
    notify FATAL "Konfigurationsscript kann nicht gestartet werden oder Konfigurationsdatei $config_dir$rc nicht gefunden"
    exit 127;
fi

notify START "Starte Backup"

# This part should do the actual copying.
source=$($config --section source --key path --emptydefault)
if [ -z "$source" ]; then
    notify FATAL "Kann Quellpfad nicht bestimmen (sollte in source::path stehen)"
    exit 127;
fi
target=$($config --section target --key path --emptydefault)
if [ -z "$target" ]; then
    notify FATAL "Kann Zielpfad nicht bestimmen (sollte in target::path stehen)"
    exit 127;
fi
exclude_file=$($config --section source --key exclude_file --emptydefault)
if [ -z "$exclude_file" ]; then
    notify FATAL "Kann nicht bestimmen, welche Dateien vom Backup ausgeschlossen werden sollen (sollte in source::exclude_file stehen)"
    exit 127;
fi
if [[ $exclude_file != /* ]]; then
    exclude_file=$config_dir$exclude_file
fi
if [ ! -r "$exclude_file" ]; then
    notify FATAL "Kann Datei mit Ausschlussliste $exclude_file nicht lesen"
    exit 127;
fi

for part in target source; do
    provide_exe=$($config --section $part --key provide --emptydefault)
    provide_if=$($config --section $part --key provide_if --default echo\ 0)
    if [ ! -z "$provide_exe" ] && [[ "$(eval $provide_if)" -eq "0" ]]; then
        eval $provide_exe
        case "$?" in
            0) # normal ok
            ;;
            1) # if exe is zenity: user clicked cancel
                notify ABORT "Bereitstellen von $part abgebrochen"
                exit 0
            ;;
            5) # if exe is zenity: timeout
                notify ABORT "Bereitstellen von $part dauerte zu lange"
                exit 0
            ;;
            *)
                notify FAIL "Bereitstellen von $part mittels $provide_exe fehlgeschlagen"
                exit 2
            ;;
        esac
    fi
done

privilege=$($config --section source --key privilege --emptydefault)
if [[ "$privilege" -ne "sudo" ]]; then
    privilege=""
fi
no_cross=$($config --section source --key no_cross --emptydefault)
if [[ "$no_cross" -ne "-x" ]]; then
    no_cross=""
fi
$privilege \
rsync --partial -a \
        $no_cross \
        --exclude-from=$exclude_file \
        $source \
        $target \
        > $config_dir/rsync.log \
        2> $config_dir/rsync.err
rsync_error=$?

case $rsync_error in
    0)
        notify SUCCESS
        exit 0;;
    23|24)
        notify SUCCESS "Nicht alle Quelldateien konnten gelesen werden";
        exit 0;;
    20)
        notify ABORT "copy aborted";
        exit 0;;
    [1246])
        notify FATAL "rsync usage error";
        exit 1;;
    3|5|10|11|12|13|14|21|22)
        notify FAIL "rsync copy error ($rsync_error)";
        exit 2;;
    25|40|35)
        notify FAIL "rsync other error $rsync_error";
        exit 3;;
    *)
        notify FAIL "Unknown rsync error $rsync_error";
        exit $rsync_error;;
esac
