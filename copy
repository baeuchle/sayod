#!/bin/bash

exec_dir=$(dirname $0)
if [ "$(which notify-send)" == "" ]; then
    echo "Kann notify-send nicht finden, bitte installieren";
    exit 127
fi

# make sure notify-send works from cronjob
export XDG_RUNTIME_DIR=/run/user/$(id -u)
# same for zenity
if [ -z "$DISPLAY" ]; then
    export DISPLAY=:0.0
fi

# may be used as provide script if user interaction is required.
function ask_provide {
    timeout=$1;
    shift;
    question="$*"
    zenity --question --timeout=$timeout --text="$question"
    case "$?" in
        0)
            return 0
        ;;
        1)
            notify ABORT "Bereitstellen abgebrochen"
            exit 0
        ;;
        5)
            notify ABORT "Bereitstellen dauerte zu lange"
            exit 0
        ;;
        *)
            return $?
        ;;
    esac
}

# may be used in provide_unless directives
function dir_exists {
    [[ -d "$*" ]]
    return $?
}

# may be used in provide_unless directives
function is_mountpoint {
    dir="$*"
    if [ "$dir" != "/" ]; then
        dir=${dir%/}
    fi
    if [ -z "$dir" ]; then return 2; fi
    mount | grep -q " $dir "
    return $?
}

function cleanup {
    for part in target source; do
        clean_cmd=$($config --section $part --key release --emptydefault)
        if [ ! -z "$clean_cmd" ]; then
            $clean_cmd
        fi
    done
    if [ -f "$rsyncerrfile" ]; then
        rm "$rsyncerrfile"
    fi
    if [ -f "$rsynclogfile" ]; then
        rm "$rsynclogfile"
    fi
}
trap cleanup EXIT

function notify {
    msgdate="$(date +%Y-%m-%dT%H:%M:%S)"
    msg=""
    level=$1
    shift
    case "$level" in
        ABORT)
            subject="ABORT"
            urgency="normal"
            head="Backup abgebrochen"
            timeout="10000"
        ;;
        FAIL) # Fehler beim Ausf√ºhren
            subject="FAIL"
            urgency="critical"
            head="Backup: Fehler $msgdate"
            timeout="60000"
        ;;
        FATAL) # Fehler im Script / Konfiguration
            subject="WTF!"
            urgency="critical"
            head="Backup-Fehler (Fatal)"
            timeout="3600000"
        ;;
        START)
            subject="START"
            urgency="low"
            head="Starte Backup"
            msg="$msgdate"
            timeout="4000"
        ;;
        SUCCESS)
            subject="SUCCESS"
            urgency="low"
            head="Backup: Erfolg"
            timeout="4000"
        ;;
        *)
            subject="$1"
            timeout="5000"
            urgency="normal"
            shift
        ;;
    esac
    msg="$* $msg"
    notify-send -u $urgency -t $timeout "$head" "$(sed 's/\\n/\n/g' <<<$msg | fold -w 36 -s)"
    loghost=$($config --section notify --key host --default localhost)
    loguser=$($config --section notify --key user --default $LOGNAME)
    logpipe=$($config --section notify --key pipe --emptydefault)
    logremote=$($config --section notify --key remotekey --default $rc)
    logmsg="content-type: text/x-plain-log\n$logremote\n$subject\n$msg"
    if [ "$logpipe" == "yes" ]; then
        echo -e "$logmsg" | ssh $loguser@$loghost receiver
        if [ $? -ne 0 ]; then
            notify-send -u critical -t 3600000 "Backup-Fehler ${rc/.rc/}" "Kann Meldungen nicht auf dem Server schreiben ($?)"
        fi
    else
        echo "$logmsg"
    fi
}

config_dir="$($exec_dir/config_dir)"
if [ "$?" -ne "0" ] || [ -z "$config_dir" ]; then
    notify FATAL "Kann Konfigurationsverzeichnis nicht bestimmen"
    exit 127;
fi

rc=rc.ini
while [ $# -gt 0 ]; do
    case "$1" in
        --config)
            shift;
            if [[ ! -z "$1" ]]; then
                rc=$1
            fi
            shift;
        ;;
        *)
            shift;
        ;;
    esac
done
config="$exec_dir/config.py --file $config_dir$rc"
if ! $config --doesfileexist --section a --key b; then
    notify FATAL "Konfigurationsscript kann nicht gestartet werden oder Konfigurationsdatei $config_dir$rc nicht gefunden"
    exit 127;
fi

notify START "Starte Backup"

# This part should do the actual copying.
source=$($config --section source --key path --emptydefault)
if [ -z "$source" ]; then
    notify FATAL "Kann Quellpfad nicht bestimmen (sollte in source::path stehen)"
    exit 127;
fi
target=$($config --section target --key path --emptydefault)
if [ -z "$target" ]; then
    notify FATAL "Kann Zielpfad nicht bestimmen (sollte in target::path stehen)"
    exit 127;
fi
exclude_file=$($config --section source --key exclude_file --emptydefault)
if [ -z "$exclude_file" ]; then
    notify FATAL "Kann nicht bestimmen, welche Dateien vom Backup ausgeschlossen werden sollen (sollte in source::exclude_file stehen)"
    exit 127;
fi
if [[ $exclude_file != /* ]]; then
    exclude_file=$config_dir$exclude_file
fi
if [ ! -r "$exclude_file" ]; then
    notify FATAL "Kann Datei mit Ausschlussliste $exclude_file nicht lesen"
    exit 127;
fi

for part in target source; do
    provide_exe=$($config --section $part --key provide --emptydefault)
    provide_unless=$($config --section $part --key provide_unless --default false)
    if [ ! -z "$provide_exe" ] && ! $provide_unless; then
        eval $provide_exe
        case "$?" in
            0) # normal ok
            ;;
            *)
                notify FAIL "Bereitstellen von $part mittels $provide_exe fehlgeschlagen ($?)"
                exit 2
            ;;
        esac
    fi
done

privilege=$($config --section source --key privilege --emptydefault)
if [[ "$privilege" -ne "sudo" ]]; then
    privilege=""
fi
no_cross=$($config --section source --key no_cross --emptydefault)
if [[ "$no_cross" -ne "-x" ]]; then
    no_cross=""
fi
rsynclogfile=$(mktemp)
rsyncerrfile=$(mktemp)
$privilege \
rsync --partial -va \
        $no_cross \
        --exclude-from=$exclude_file \
        $source \
        $target \
        > $rsynclogfile \
        2> $rsyncerrfile
rsync_error=$?

loglines=$(wc -l < $rsynclogfile)
log_in_one_line=$(awk 1 ORS='\\n' "$rsynclogfile")
errlines=$(wc -l < $rsyncerrfile)
err_in_one_line=$(awk 1 ORS='\\n' "$rsyncerrfile")
case $rsync_error in
    0)
        notify SUCCESS "$err_in_one_line";
        exit 0;;
    23|24)
        notify SUCCESS "Nicht alle Quelldateien konnten gelesen werden\\n$err_in_one_line";
        exit 0;;
    20)
        notify ABORT "Kopiervorgang abgebrochen $loglines/$errlines Zeilen\\n$err_in_one_line";
        exit 0;;
    [1246])
        notify FATAL "rsync falsch benutzt $rsync_error\\n$err_in_one_line";
        exit 1;;
    3|5|10|11|12|13|14|21|22)
        notify FAIL "rsync copy error $rsync_error\\n$err_in_one_line";
        exit 2;;
    25|40|35)
        notify FAIL "rsync other error $rsync_error\\n$err_in_one_line";
        exit 3;;
    *)
        notify FAIL "Unknown rsync error $rsync_error\\n$err_in_one_line";
        exit $rsync_error;;
esac
