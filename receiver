#!/usr/bin/python3

import sys
from pathlib import Path
import argparse
import config
import datetime

config_base = Path.home() / '.config' / 'backup'

line = sys.stdin.readline().strip()
content_type = "text/x-plain-log"
if line.startswith("content-type: "):
    content_type = line[len("content-type: "):]
    line = sys.stdin.readline().strip()

if not content_type == "text/x-plain-log":
    print("Kann andere Daten als plain log nicht lesen!", file=sys.stderr)
    sys.exit(15)

givenpath = Path(line)
if givenpath.is_absolute():
    config_file = givenpath
else:
    config_file = config_base / givenpath

for line in sys.stdin:
    if line.strip() == "":
        continue
    subject = line.strip()
    break

# remainder: content.
content = sys.stdin.read().strip().replace("\n", '\\n')

status, log_file = config.find_entry(config_file, "status", "file")
if status != 0:
    print("Cannot find status target", file=sys.stderr)
    sys.exit(status)

with open(log_file, 'a') as log:
    log.write("{:%Y-%m-%dT%H:%M:%S} {} {}\n".format(datetime.datetime.now(), subject, content))
