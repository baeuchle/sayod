#!/usr/bin/python3

import sys

from config import Config
from log import LogEntry, Log

line = sys.stdin.readline().strip()
content_type = "text/x-plain-log"
if line.startswith("content-type: "):
    content_type = line[len("content-type: "):]
    line = sys.stdin.readline().strip()

if not content_type == "text/x-plain-log":
    print("Kann andere Daten als plain log nicht lesen!", file=sys.stderr)
    sys.exit(15)


config = Config(line)
entry = LogEntry("")

for line in sys.stdin:
    if line.strip() == "":
        continue
    entry.subject = line.strip()
    break

# remainder: content.
entry.content = sys.stdin.read().strip()

status, log_file = config.find_entry("status", "file")
if status != 0:
    print("Cannot find status::file in", config.file_name, file=sys.stderr)
    sys.exit(status)

with open(log_file, 'a') as log:
    log.write(str(entry) + "\n")
